/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'java'
    id 'scala'
    id 'maven-publish'
    id 'application'
}

compileJava {
    sourceCompatibility = 1.6
    targetCompatibility = 1.7
}

configurations {
    deps // dummy configuration to resolve zinc
}

repositories {
    maven {
        url = uri('https://repo.maven.apache.org/maven2')
    }
    maven {
        url = uri('https://maven.cloudant.com/repo/')
    }
}

dependencies {
    // scala
    compileOnly 'org.scala-lang:scala-compiler:2.9.1'
    // zinc cannot be used for clouseau so we use dummy configuration
    deps 'com.typesafe.zinc:zinc:0.3.13'
    implementation 'org.scala-lang:scala-library:2.9.1'
    testImplementation 'org.scala-lang:scala-library:2.9.1'
    implementation 'commons-configuration:commons-configuration:1.8'

    // scalang and its dependencies
    implementation 'com.boundary:scalang-scala_2.9.1:0.28-cloudant6'
    implementation 'com.boundary:overlock-scala_2.9.1:0.8.4'
    implementation 'com.boundary:high-scale-lib:1.0.4'
    implementation 'com.boundary:logula_slf4j_2.9.1:2.1.3-p01'

    // lucene
    implementation 'org.apache.lucene:lucene-grouping:4.6.1'
    implementation 'org.apache.lucene:lucene-queryparser:4.6.1'
    implementation 'org.apache.lucene:lucene-analyzers-common:4.6.1'
    implementation 'org.apache.lucene:lucene-analyzers-stempel:4.6.1'
    implementation 'org.apache.lucene:lucene-analyzers-smartcn:4.6.1'
    implementation 'org.apache.lucene:lucene-analyzers-kuromoji:4.6.1'
    implementation 'org.apache.lucene:lucene-facet:4.6.1'
    implementation 'org.apache.lucene:lucene-spatial:4.6.1'
    implementation 'org.apache.lucene:lucene-highlighter:4.6.1'

    // logging
    implementation 'org.slf4j:slf4j-log4j12:1.5.6'

    // metrics
    implementation 'com.yammer.metrics:metrics-scala_2.9.1:2.0.0'

    // testing
    testImplementation 'junit:junit:4.13.1'
    testImplementation 'org.specs2:specs2_2.9.1:1.12.4'
    testImplementation 'org.pegdown:pegdown:1.4.0'
}


group = 'com.cloudant'
version = '2.18.1-SNAPSHOT'
description = 'clouseau'

publishing {
    publications {
        maven(MavenPublication) {
            from(components.java)
        }
    }
}

mainClassName = 'com.cloudant.clouseau.Main'

run {
    if (project.hasProperty("node")) {
        def node = project.property("node")
        applicationDefaultJvmArgs = [
            "-Dlog4j.configuration=file:src/test/resources/log4j.properties",
            "-Dclouseau.cookie=monster",
            "-Dclouseau.name=${node}@127.0.0.1",
            "-Dclouseau.dir=${projectDir}/target/${node}"
        ]
    }
    doLast {
        if (!(project.hasProperty("node"))) {
            throw new InvalidUserDataException("""
            Please add '-Pnode=<node>' (i.e. `-Pnode=clouseau1`)
            """.stripIndent())
        }
    }
}

test {
    def should_skip = (findProperty('skip_tests') ?: false)
    if (!should_skip) {
        useJUnit()
        maxHeapSize = '1G'
        systemProperty "specs2.commandline" , "html"
        systemProperty "specs2.outDir"  ,   "$buildDir/reports/specs2"
    }
}

task downloadDependencies {
    doLast {
       configurations.findAll{it.canBeResolved}.each{it.resolve()}
    }
}
